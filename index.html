<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task Manager</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f4f6f9;
      margin: 0;
      padding: 0;
    }

    header {
      background: #4f46e5;
      color: white;
      padding: 1rem;
      font-size: 1.5rem;
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logout-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .logout-btn:hover { background: #dc2626; }

    /* ---------- Login Section ---------- */
    #login-section { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
    .login-card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); width: 320px; text-align: center; }
    .login-card h2 { margin-bottom: 1rem; }
    .login-card input { width: 100%; padding: 0.8rem; margin: 0.5rem 0; border-radius: 8px; border: 1px solid #ccc; font-size: 0.9rem; }
    .login-card button { width: 100%; padding: 0.8rem; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; margin-top: 0.8rem; }
    .login-card button:hover { background: #4338ca; }

    /* ---------- Task Section ---------- */
    #task-section { display: none; }
    .filter-bar { display: flex; justify-content: center; gap: 1rem; padding: 1rem; }
    .filter-bar select, .filter-bar button { padding: 0.5rem 0.8rem; border-radius: 6px; border: 1px solid #ccc; cursor: pointer; font-size: 0.9rem; font-weight: 600; }
    .task-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; padding: 1rem; }
    .task-card { background: white; border-radius: 12px; padding: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .task-card:hover { transform: translateY(-3px); box-shadow: 0 6px 16px rgba(0,0,0,0.12); }
    .task-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; }
    .task-desc { font-size: 0.9rem; color: #555; margin-bottom: 0.8rem; }
    .task-meta { font-size: 0.8rem; color: #777; margin-bottom: 0.5rem; }
    .status { display: inline-block; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
    .status.completed { background: #dcfce7; color: #166534; }
    .status.pending { background: #fef3c7; color: #92400e; }
    .status.onhold { background: #e5e7eb; color: #374151; }
    .task-actions { display: flex; justify-content: flex-end; gap: 0.5rem; }
    .task-actions button { border: none; padding: 0.4rem 0.7rem; border-radius: 6px; cursor: pointer; font-size: 0.75rem; transition: background 0.2s ease; }
    .edit-btn { background: #3b82f6; color: white; }
    .edit-btn:hover { background: #2563eb; }
    .delete-btn { background: #ef4444; color: white; }
    .delete-btn:hover { background: #dc2626; }

    /* Floating Add Button */
    .fab { position: fixed; bottom: 1.5rem; right: 1.5rem; background: #4f46e5; color: white; border: none; border-radius: 50%; width: 55px; height: 55px; font-size: 1.5rem; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; transition: background 0.2s ease; }
    .fab:hover { background: #4338ca; }

    /* Modal */
    .modal { display: none; position: fixed; z-index: 10; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
    .modal-content { background: white; padding: 1.5rem; border-radius: 12px; width: 350px; max-width: 90%; }
    .modal-content h3 { margin-top: 0; }
    .modal-content input, .modal-content select { width: 100%; margin: 0.5rem 0; padding: 0.6rem; border: 1px solid #ccc; border-radius: 6px; }
    .modal-content button { margin-top: 0.8rem; padding: 0.7rem 1rem; border: none; border-radius: 6px; background: #4f46e5; color: white; cursor: pointer; width: 100%; }
  </style>
</head>
<body>
  <header>
    Task Manager
    <button class="logout-btn" onclick="logout()">Logout</button>
  </header>

  <!-- ---------- LOGIN ---------- -->
  <div id="login-section">
    <div class="login-card">
      <h2>Login</h2>
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="Password">
      <button type="submit" onclick="login()">Login</button>
    </div>
  </div>

  <!-- ---------- TASKS ---------- -->
  <div id="task-section">
    <div class="filter-bar">
      <select id="statusFilter" onchange="renderTasks()">
        <option value="all">All</option>
        <option value="completed">Completed</option>
        <option value="pending">Pending</option>
        <option value="onhold">On Hold</option>
      </select>
      <button onclick="downloadExcel()">â¬‡ Download Excel</button>
    </div>

    <div class="task-container" id="task-list"></div>
    <button class="fab" onclick="openModal()">+</button>
  </div>

  <!-- ---------- MODAL (Add/Edit Task) ---------- -->
  <div class="modal" id="task-modal">
  <div class="modal-content">
    <h3 id="modal-title">Add Task</h3>
    
    <label for="task-title">Task Title</label>
    <input type="text" id="task-title" placeholder="Task Title">
    
    <label for="task-desc">Description</label>
    <input type="text" id="task-desc" placeholder="Description">      
    
    <label for="task-category">Category</label>
    <select id="task-category">
      <option value="Technical">Technical</option>
      <option value="Personal">Personal</option>
      <option value="Other">Other</option>
    </select>
    
    <label for="task-priority">Priority</label>
    <select id="task-priority">
      <option value="High">High</option>
      <option value="Medium">Medium</option>
      <option value="Low">Low</option>
    </select>
    
    <label for="task-date">Due Date</label>
    <input type="date" id="task-date">
    
    <label for="task-status">Status</label>
    <select id="task-status">
      <option value="pending">Pending</option>
      <option value="completed">Completed</option>
      <option value="onhold">On Hold</option>
    </select>
    
    <button onclick="saveTask()">Save</button>
  </div>
</div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>
  <!-- SheetJS for Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA83uxWbHceRY_KEeA4wzKYWZUn4WxWdnw",
      authDomain: "task-19ac2.firebaseapp.com",
      projectId: "task-19ac2",
      storageBucket: "task-19ac2.firebasestorage.app",
      messagingSenderId: "1015620699391",
      appId: "1:1015620699391:web:ddb4a69b403694fe3c38ca",
      measurementId: "G-JTE9CHWZ4Z"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let editingTaskId = null;
    let allTasks = [];
    let sessionTimer;

   function resetSession() {
  clearTimeout(sessionTimer);
  sessionTimer = setTimeout(() => {
    alert("Session expired! Auto logged out.");
    logout();
  }, 15 * 60 * 1000); // 15 minutes
}

    function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      auth.signInWithEmailAndPassword(email, password)
        .then(userCredential => {
          currentUser = userCredential.user;
          document.getElementById("login-section").style.display = "none";
          document.getElementById("task-section").style.display = "block";
          loadTasks();
          resetSession();
          alert("Login successful!");
        })
        .catch(err => alert("Login failed: " + err.message));
    }

    document.getElementById("password").addEventListener("keypress", e => {
      if (e.key === "Enter") login();
    });

    function logout() {
      auth.signOut().then(() => {
        currentUser = null;
        document.getElementById("login-section").style.display = "flex";
        document.getElementById("task-section").style.display = "none";
      });
    }

    function loadTasks() {
      db.collection("tasks").where("owner", "==", currentUser.uid)
        .onSnapshot(snapshot => {
          allTasks = [];
          snapshot.forEach(doc => allTasks.push({ id: doc.id, ...doc.data() }));
          renderTasks(allTasks);
        });
    }

  

    function openModal() {
      document.getElementById("task-modal").style.display = "flex";
      document.getElementById("modal-title").innerText = "Add Task";
      editingTaskId = null;
    }

    function editTask(id, title, desc, category, priority, date, status) {
      document.getElementById("task-modal").style.display = "flex";
      document.getElementById("modal-title").innerText = "Edit Task";
      document.getElementById("task-title").value = title;
      document.getElementById("task-desc").value = desc;
      document.getElementById("task-category").value = category;
      document.getElementById("task-priority").value = priority;
      document.getElementById("task-date").value = date;
      document.getElementById("task-status").value = status;
      editingTaskId = id;
    }

    
    function closeModal() {
      document.getElementById("task-modal").style.display = "none";
      document.getElementById("task-title").value = "";
      document.getElementById("task-desc").value = "";
      document.getElementById("task-category").value = "";
      document.getElementById("task-priority").value = "Medium";
      document.getElementById("task-date").value = "";
      document.getElementById("task-status").value = "pending";
    }

    document.getElementById("task-modal").addEventListener("click", e => {
      if (e.target.id === "task-modal") closeModal();
    });

    function downloadExcel() {
      const ws = XLSX.utils.json_to_sheet(allTasks.map(t => ({
        Title: t.title,
        Description: t.description,
        Category: t.category,
        Priority: t.priority,
        Date: t.date,
        Status: t.status,
        completed_Date: t.completed_date
      })));
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Tasks");
      XLSX.writeFile(wb, "tasks.xlsx");
    }

    // ---------- RENDER TASKS ----------
function renderTasks(tasks = []) {
  const statusFilter = document.getElementById("statusFilter").value;
  const taskList = document.getElementById("task-list");
  taskList.innerHTML = "";

  tasks.filter(task =>
    statusFilter === "all" || task.status === statusFilter
  ).forEach(task => {
    const card = document.createElement("div");
    card.className = "task-card";
    card.innerHTML = `
      <div class="task-title">${task.title}</div>
      <div class="task-desc">${task.description}</div>
      <div class="task-meta">
        Due: ${task.date || "N/A"} |
        Completed: ${task.completed_date || "N/A"} |
        Category: ${task.category || "N/A"} |
        Priority: ${task.priority || "N/A"}
      </div>
      <span class="status ${task.status}">${task.status}</span>
      <div class="task-actions">
        <button class="edit-btn" onclick="editTask(
          '${task.id}',
          '${task.title}',
          '${task.description}',
          '${task.category}',
          '${task.priority}',
          '${task.date}',
          '${task.status}',
          '${task.completed_date || ""}'
        )">Edit</button>
        <button class="delete-btn" onclick="deleteTask('${task.id}')">Delete</button>
      </div>
    `;
    taskList.appendChild(card);
  });
}

// ---------- SAVE TASK ----------
function saveTask() {
  const title = document.getElementById("task-title").value;
  const desc = document.getElementById("task-desc").value;
  const category = document.getElementById("task-category").value;
  const priority = document.getElementById("task-priority").value;
  const date = document.getElementById("task-date").value;
  const status = document.getElementById("task-status").value;

  let completed_date = null;
  if (status === "completed") {
    
    if (editingTaskId && allTasks.find(t => t.id === editingTaskId)?.completed_date) {
      completed_date = allTasks.find(t => t.id === editingTaskId).completed_date;
    } else {
      
      const today = new Date();
      completed_date = today.toISOString().split("T")[0];
    }
  }

  if (editingTaskId) {
    db.collection("tasks").doc(editingTaskId).update({ 
      title, description: desc, category, priority, date, status, completed_date 
    })
    .then(() => alert("Task updated!"));
  } else {
    db.collection("tasks").add({ 
      title, description: desc, category, priority, date, status, completed_date, owner: currentUser.uid 
    })
    .then(() => alert("Task added!"));
  }

  closeModal();
  resetSession();
}
firebase.auth().onAuthStateChanged(user => {
  if (user) {
    currentUser = user;
    document.getElementById("login-section").style.display = "none";
    document.getElementById("task-section").style.display = "block";
    loadTasks();
    resetSession(); // 15 min
  } else {
    currentUser = null;
    document.getElementById("login-section").style.display = "flex";
    document.getElementById("task-section").style.display = "none";
  }
});

  </script>
</body>
</html>
